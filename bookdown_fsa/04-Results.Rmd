---
output:
  html_document: default
  pdf_document: default
---
# Results and Plots


```{r data-preparation ,echo=FALSE, message=FALSE}
library(ggplot2)
library(shiny)

library(scales)
library(ggrepel)

library(tidyr)
library(magrittr)
library(dplyr)


# Removal of News as a datasource from our data
labelled.df <- subset(labelled.df, source != "News")

# Creation of 2 columns in labelled.df called <severe_reaction>, <mild_reaction> for plotting purposes
labelled.df$severe_reaction <- ifelse(labelled.df$reactions_report == "Severe-reaction", 1, 0)
labelled.df$mild_reaction <- ifelse(labelled.df$reactions_report == "Mild-reaction", 1, 0)
```

## 14 allergens
In the representation below, we display the number of mentions of predefined list of 14 allergens, whether coming from Blog, News, Review, Forum or Twitter.

```{r fourteenallergens, echo=FALSE, message=FALSE}

# if (knitr::is_latex_output() | knitr::is_html_output()) {
#   


# Long Dataframe needed for certain types of plots.
labelled.df.long <- gather(labelled.df, Allergen, "Mentions", c(fourteen.allergen.names,other.allergen.names), factor_key = TRUE)


allergen.bysource.df <- labelled.df.long %>%
  group_by(source, Allergen) %>%
  summarise(count=sum(Mentions))

library(ggplot2)
library(forcats)

fourteen.bysource <- ggplot(subset(allergen.bysource.df, Allergen %in% fourteen.allergen.names),
                                 aes(x = reorder(gsub("_"," ",Allergen), count), y = count, fill = source)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  scale_fill_brewer(palette="Spectral") +
  xlab("Allergen")+
  ylab("Mentions") +
  ggtitle("Mentions of the 14 Allergens by Source")+
  coord_flip()
fourteen.bysource
  
# } else {
# shinyApp(
# 
#   ui = fluidPage(
#     selectInput("region", "Region:",
#                 choices = colnames(WorldPhones)),
#     plotOutput("phonePlot")
#   ),
# 
#   server = function(input, output) {
#     output$phonePlot = renderPlot({
#       barplot(WorldPhones[,input$region]*1000,
#               ylab = "Number of Telephones", xlab = "Year")
#     })
#   },
# 
#   options = list(height = 500)
# )
# }
```




## Other Allergens
```{r other-allergens, echo=FALSE,message=FALSE}

if (knitr::is_latex_output() | knitr::is_html_output()) {
  
other.bysource <- ggplot(subset(allergen.bysource.df,
                                Allergen %in% other.allergen.names),
                                aes(x = reorder(gsub("_"," ", Allergen),count), y = count, fill = source)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  scale_fill_brewer(palette="Spectral") +
  xlab("Allergen") +
  ylab("Mentions") +
  ggtitle("Mentions of Other Allergens by Source") +
  coord_flip()
other.bysource
  
} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```


## TOP 14 Allergens
```{r top-10-allergens, echo=FALSE,message=FALSE}


if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  
total_count_per_allergen <- labelled.df %>% subset(select = c(fourteen.allergen.names,other.allergen.names)) %>% colSums(na.rm=T) %>% sort(decreasing=T)
top_10_names <- names(total_count_per_allergen)[1:10]

top10.bysource <- ggplot(subset(allergen.bysource.df, Allergen %in% top_10_names),
                            aes(x = reorder(gsub("_"," ",Allergen), count), y = count, fill = source)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  scale_fill_brewer(palette="Spectral") +
  xlab("Allergen")+
  ylab("Mentions") +
  ggtitle("TOP 10 Allergens by Source")+
  coord_flip()
top10.bysource
  
} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```

## 14 Allergens Mentions over time (Twitter only)
```{r fourteenallergensovertime , echo=TRUE,message=TRUE}
# if (1 == 1) {
#   
all_allergens.norm.df.t14 <- subset(labelled.df.long,
                                    source == "Twitter" &
                                      Allergen %in% fourteen.allergen.names)
# Remove "_" from allergens name
all_allergens.norm.df.t14$Allergen <- gsub("_"," ",all_allergens.norm.df.t14$Allergen)

# by.month.twitter.14 <- ggplot(all_allergens.norm.df.t14,
#                                    aes(x = Month, y = Mentions, colour = Allergen),
#                                    group = Allergen) +
#   stat_summary(fun.y = sum, # adds up all observations for the month
#                geom = "line") +
#   theme_minimal()+
#   theme(legend.position="bottom")+
#   facet_grid(sentiment_class~.)
# by.month.twitter.14

by.week.twitter.14 <- ggplot(all_allergens.norm.df.t14,
                                  aes(x = Week, y = Mentions, colour = Allergen),
                                  group = Allergen) +
  stat_summary(fun.y = sum, # adds up all observations for the week
               geom = "line") +
  theme_minimal() +
  theme(legend.position="bottom") +
  facet_grid(sentiment_class~.) +
  ggtitle("14 Allergen Mentions over Time (Twitter Only)")+
  theme(strip.text.y = element_text(angle = 0))
by.week.twitter.14
  
# } else {
# shinyApp(
# 
#   ui = fluidPage(
#     selectInput("region", "Region:",
#                 choices = colnames(WorldPhones)),
#     plotOutput("phonePlot")
#   ),
# 
#   server = function(input, output) {
#     output$phonePlot = renderPlot({
#       barplot(WorldPhones[,input$region]*1000,
#               ylab = "Number of Telephones", xlab = "Year")
#     })
#   },
# 
#   options = list(height = 500)
# )
# }
```


## Other Allergens mentions over time (Twitter only)
```{r other-allergens-over-time , echo=FALSE,message=FALSE}

if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  
all_allergens.norm.df.t.other <- subset(labelled.df.long, source == "Twitter" & Allergen %in% other.allergen.names)
# Remove "_" from allergens name
all_allergens.norm.df.t.other$Allergen <- gsub("_"," ",all_allergens.norm.df.t.other$Allergen)

by.month.twitter.other <- ggplot(all_allergens.norm.df.t.other, aes(x = Month, y = Mentions, colour = Allergen), group = Allergen)+
  stat_summary(fun.y = sum, # adds up all observations for the month
               geom = "line") +
  theme_minimal()+
  theme(legend.position="bottom") +
  facet_grid(sentiment_class~.) +
  theme(strip.text.y = element_text(angle = 0))
by.month.twitter.other

by.week.twitter.other <- ggplot(all_allergens.norm.df.t.other, aes(x = Week, y = Mentions, colour = Allergen), group = Allergen)+
  stat_summary(fun.y = sum, # adds up all observations for the month
               geom = "line") +
  theme_minimal()+
  theme(legend.position="bottom") +
  facet_grid(sentiment_class~.) +
  ggtitle("Other Allergen Mentions over Time (Twitter Only)")+
  theme(strip.text.y = element_text(angle = 0))
by.week.twitter.other
  
} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```

## Allergen Enquiries diplayed by Source and Sentiment
```{r allergens-enquiries-source-sentiment , echo=FALSE,message=TRUE}

if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  
  enquiries_source_react.bar <- ggplot(labelled.df, aes(x = source, y = allergy_enquiries, fill = sentiment_class))+
  stat_summary(fun.y = sum, # adds up all observations for the month
               geom = "bar") +
  theme_minimal() +
  labs(x= "Source", y="Allergen Enquiries", fill = "Sentiment Class") +
  scale_fill_manual(values = c("#DF3309","grey80","#0D83E6"))+
  ggtitle("Allergen Enquiries by Source and Sentiment Class")
enquiries_source_react.bar
  
} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```


## Food Labelling diplayed by Source and Sentiment
```{r food-labelling-source-sentiment , echo=FALSE,message=FALSE}

if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  
  labelling_source_react.bar <- ggplot(labelled.df, aes(x = source, y = food_labelling, fill = sentiment_class))+
  stat_summary(fun.y = sum, # adds up all observations for the month
               geom = "bar") +
  theme_minimal() +
  labs(x= "Source", y="Mentions Flagged for Food Labelling", fill = "Sentiment Class") +
  scale_fill_manual(values = c("#DF3309","grey80","#0D83E6"))+
  ggtitle("Food Labelling Mentions by Source and Sentiment Class")
labelling_source_react.bar

} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```

## Allergen Enquiries, Food Labelling and Reactions Reporting combined by sentiment class
```{r stream1-issues-sentiment , echo=FALSE,message=FALSE}
if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  
  stream1.issues.names <- c("allergy_enquiries","food_labelling","mild_reaction","severe_reaction")
  stream1.issues.df <- subset(labelled.df, select = c(stream1.issues.names,"sentiment_class"))
  
  stream1.issues.df.long <- gather(stream1.issues.df, Issue, "Mentions", stream1.issues.names, factor_key = TRUE)
  
  stream1.issues.sentiment.groupedby <-stream1.issues.df.long %>%
    group_by(Issue, sentiment_class) %>%
    summarise(counts = sum(Mentions))
    
  stream1.issues.bar <- ggplot(stream1.issues.sentiment.groupedby,
                               aes(x = gsub("_", " ", Issue), y = counts, fill = sentiment_class)) +
    geom_bar(stat = "identity") +
    theme_minimal() +
    labs(x= "Issues", y="Mentions", fill = "Sentiment Class") +
    scale_fill_manual(values = c("#DF3309","grey80","#0D83E6"))+
    theme(legend.position="bottom") +
    ggtitle("Stream 1 issues per sentiment")
  stream1.issues.bar

} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```

## Percentage of 14 allergens mentions for which we have a mild/severe reaction
```{r percentage-14allergens-reactions , echo=FALSE,message=FALSE}
if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  fourteen.allergen.mild <- colSums(labelled.df[labelled.df$mild_reaction == 1,fourteen.allergen.names])
  fourteen.allergen.severe <- colSums(labelled.df[labelled.df$severe_reaction == 1,fourteen.allergen.names])
  fourteen.allergen.total <- colSums(labelled.df[,fourteen.allergen.names])
  
  fourteen.allergens.total.df <- data.frame(fourteen.allergen.mild,fourteen.allergen.severe,fourteen.allergen.total)
  
  colnames(fourteen.allergens.total.df) <- c("mild","severe","total")
  
  fourteen.allergens.total.df$perc_mild <- round((fourteen.allergens.total.df$mild/fourteen.allergens.total.df$total)*100,1)
  fourteen.allergens.total.df$perc_severe <- round((fourteen.allergens.total.df$severe/fourteen.allergens.total.df$total)*100,1)
  fourteen.allergens.total.df$allergen <- rownames(fourteen.allergens.total.df)
  
  fourteen.allergen.total.long <- gather(fourteen.allergens.total.df, severity, "percentage", c("perc_mild","perc_severe"), factor_key = TRUE)
  
  
  fourteen.allergen.mentions <- ggplot(fourteen.allergen.total.long,
                                       aes(x = gsub("_"," ", allergen),
                                           y = percentage, fill = severity)) +
    geom_bar(width = 0.4 ,position = "dodge", stat="identity") +
    theme_minimal() +
    scale_fill_manual(values=c("#ffa64d", "#cc0000"), 
                      breaks=c("perc_mild", "perc_severe"),
                      labels=c("% Midl", "% Severe")) +
    labs(x= "Allergens", y="Percentage", fill = "Severity") +
    #ggtitle("Percentage of Mild/Severe reactions over 14 allergens mentions") +
    coord_flip()
  fourteen.allergen.mentions

} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```

## Reactions to 14 Allergens Mentions over time from all sources
```{r 14allergens-reactions-all-sources , echo=FALSE,message=FALSE}
if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  
  int_14allergen_react.df <- subset(labelled.df.long, Mentions > 0 & Allergen %in% fourteen.allergen.names)
  int_14allergen_react.df$Allergen <- gsub("_"," ", int_14allergen_react.df$Allergen)
  
  int_14allergen_react <- ggplot(int_14allergen_react.df,
                                 aes(x = Week, y = reactions_report, fill = reactions_report))+
    stat_summary(fun.y = sum, # adds up all observations for the month
                 geom = "bar") +
    scale_fill_manual(values = c("grey90","yellow","red"))+
    labs(x="Month", y="Mentions", fill="Class of Reported Reaction")+
    scale_x_date(breaks = "month")+
    #ggtitle("Reactions to 14 Allergen Mentions Over Time (All Sources)")+
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                     size = 12, hjust = 1))+
    theme(axis.text.y = element_blank())+
    theme(panel.grid.minor = element_blank())+
    theme(strip.text.y = element_text(angle = 0))+
    theme(legend.position="bottom")+
    facet_grid(Allergen~.)
  int_14allergen_react

} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```


## Reactions to the 14 Allergens over time, including all sources
```{r 14allergens-reactions-all-sources-bubbles , echo=FALSE,message=FALSE}
if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  allergen.react.df <- subset(labelled.df.long, Allergen %in% fourteen.allergen.names) %>%
  group_by(Allergen, Month, sentiment_class, reactions_report) %>%
  summarise(Count= sum(Mentions))

  #Remove "_" from allergens names
  allergen.react.df$Allergen <- gsub("_"," ",allergen.react.df$Allergen)
  allergen.react.bubble <- ggplot(allergen.react.df, aes(x = Month, y = fct_reorder(Allergen, Count),
                                                  size = ifelse(Count == 0, NA, Count),
                                                  colour = reactions_report))+
    geom_point()+
    scale_size_area(max_size = 10)+
    scale_colour_manual(values = c("grey90","yellow","red"))+
    labs(x="Month", y="Allergen", size="Number of Mentions",
         col="Class of Reported Reaction")+
    scale_x_date(breaks = "month")+
    #ggtitle("Reactions to 14 Allergen Mentions Over Time (All Sources)")+
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                     size = 12, hjust = 1))+
    theme(panel.grid.minor = element_blank())+
    theme(strip.text.y = element_text(angle = 0))+
    facet_grid(sentiment_class~.)
  allergen.react.bubble

} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```


## Reactions to the 14 Allergens over time, including all sources and flagged under Food Labelling
```{r 14allergens-reactions-all-sources-bubbles-labelling , echo=FALSE,message=FALSE, warning=FALSE}
if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  allergen.react.labelling.df <- subset(labelled.df.long, Allergen %in% fourteen.allergen.names & food_labelling > 0) %>%
  group_by(Allergen, Month, sentiment_class, reactions_report) %>%
  summarise(Count= sum(Mentions))

  #Remove "_" from allergen names
  allergen.react.labelling.df$Allergen <- gsub("_", " ", allergen.react.labelling.df$Allergen)
  
  allergen.react.labelling.bubble <- ggplot(allergen.react.labelling.df, aes(x = Month, y = fct_reorder(Allergen, Count),
                                                         size = ifelse(Count == 0, NA, Count),
                                                         colour = reactions_report))+
    geom_point()+
    scale_size_area(max_size = 10)+
    scale_colour_manual(values = c("grey90","yellow","red"))+
    labs(x="Month", y="Allergen", size="Number of Mentions",
         col="Class of Reported Reaction")+
    scale_x_date(breaks = "month")+
    #ggtitle("Reactions to 14 Allergen Mentions Over Time (All Sources, Flagged under Food Labelling)")+
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                     size = 12, hjust = 1))+
    theme(panel.grid.minor = element_blank())+
    theme(strip.text.y = element_text(angle = 0))+
    facet_grid(sentiment_class~.)
  allergen.react.labelling.bubble

} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```


## Reactions to the 14 Allergens over time, including all sources and flagged under Allergy Enquiries
```{r 14allergens-reactions-all-sources-bubbles-enquiries , echo=FALSE,message=FALSE, warning=FALSE}
if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  allergen.react.enquiries.df <- subset(labelled.df.long, Allergen %in% fourteen.allergen.names & allergy_enquiries > 0) %>%
  group_by(Allergen, Month, sentiment_class, reactions_report) %>%
  summarise(Count= sum(Mentions))

  allergen.react.enquiries.bubble <- ggplot(allergen.react.labelling.df, aes(x = Month, y = fct_reorder(Allergen, Count),
                                                                           size = ifelse(Count == 0, NA, Count),
                                                                           colour = reactions_report))+
    geom_point()+
    scale_size_area(max_size = 10)+
    scale_colour_manual(values = c("grey90","yellow","red"))+
    labs(x="Month", y="Allergen", size="Number of Mentions",
         col="Class of Reported Reaction")+
    scale_x_date(breaks = "month")+
    ggtitle("Reactions to 14 Allergen Mentions Over Time (All Sources, Flagged under Allergy Enquiries)")+
    theme_minimal()+
    theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                     size = 12, hjust = 1))+
    theme(strip.text.y = element_text(angle = 0))+
    theme(panel.grid.minor = element_blank())+
    facet_grid(sentiment_class~.)
  allergen.react.enquiries.bubble

} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```


## Reported Reactions to Other Allergens Over Time (All Sources)
```{r other-allergens-reactions-overtime , echo=FALSE,message=FALSE, warning=FALSE}
if (knitr:::is_latex_output() | knitr:::is_html_output()) {
  # Subseting to remove "_" from allergen names
  int_otherallergen_react.df <- subset(labelled.df.long, Mentions > 0 & Allergen %in% other.allergen.names)
  int_otherallergen_react.df$Allergen <- gsub("_", " ", int_otherallergen_react.df$Allergen)
  int_otherallergen_react <- ggplot(int_otherallergen_react.df,
                                 aes(x = Week, y = reactions_report, fill = reactions_report))+
    stat_summary(fun.y = sum, # adds up all observations for the month
                 geom = "bar") +
    theme_minimal() +
    labs(x="Month", y="Mentions", fill="Class of Reported Reaction")+
    scale_fill_manual(values = c("grey90","yellow","red"))+
    ggtitle("Reported Reactions to Other Allergens Over Time (All Sources)")+
    scale_x_date(breaks = "month")+
    facet_grid(Allergen~.)+
    theme(strip.text.y = element_text(angle = 0))+
    theme(axis.text.y = element_blank())+
    theme(axis.text.x = element_text(angle = 45, vjust = 1,
                                   size = 12, hjust = 1))+
    theme(legend.position="bottom")+
    theme(panel.grid.minor = element_blank())
  int_otherallergen_react

} else {
shinyApp(

  ui = fluidPage(
    selectInput("region", "Region:",
                choices = colnames(WorldPhones)),
    plotOutput("phonePlot")
  ),

  server = function(input, output) {
    output$phonePlot = renderPlot({
      barplot(WorldPhones[,input$region]*1000,
              ylab = "Number of Telephones", xlab = "Year")
    })
  },

  options = list(height = 500)
)
}
```


